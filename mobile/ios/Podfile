# Rabby iOS Native Wallet Podfile
# 纯原生Swift实现

platform :ios, '15.0'
use_frameworks!
inhibit_all_warnings!

target 'RabbyMobile' do
  # 核心加密库
  pod 'CryptoSwift', '~> 1.8'        # Keccak256, AES等加密算法
  
  # secp256k1 椭圆曲线 (签名/公钥派生)
  pod 'secp256k1.swift', '~> 0.1'     # bitcoin-core secp256k1 C库封装

  # JSON 泛型类型 (EIP-712)
  pod 'GenericJSON', '~> 2.0'         # 用于EIP-712 TypedData

  # 大整数运算 (Wei转换)
  pod 'BigInt', '~> 5.0'              # 大数运算用于ETH金额计算
  
  # WalletConnect v2
  pod 'WalletConnectSwiftV2', '~> 1.9' # WalletConnect v2协议
  
  # WebSocket (WalletConnect依赖)
  pod 'Starscream', '~> 4.0'          # WebSocket通信
  
  # 网络请求
  pod 'Alamofire', '~> 5.8'           # HTTP网络请求
  
  # 图片缓存加载 (Token/NFT icons)
  pod 'Kingfisher', '~> 7.10'         # 异步图片加载与缓存
  
  # 二维码生成
  pod 'EFQRCode', '~> 6.2'            # 二维码生成(收款)
  
  # Keychain安全存储
  pod 'KeychainAccess', '~> 4.2'      # Keychain简化封装
  
  # Lottie动画 (加载/成功动效)
  pod 'lottie-ios', :git => 'https://gitee.com/mirrors/lottie-ios.git', :tag => '4.6.0'
  
  # 开发工具
  pod 'SwiftLint', '~> 0.54', :configurations => ['Debug']
end

post_install do |installer|
  # Fix rsync sandbox permission errors in Xcode 15+ for main project
  installer.generated_projects.each do |project|
    project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      end
    end
  end

  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
      config.build_settings['ENABLE_BITCODE'] = 'NO'
      config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'NO'
      config.build_settings['ENABLE_MODULE_VERIFIER'] = 'NO'

      # Fix rsync sandbox permission errors in Xcode 15+
      config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
      
      # Fix framework header warnings (double-quoted includes, @import)
      if ['EFQRCode', 'secp256k1.swift'].include?(target.name)
        config.build_settings['CLANG_ENABLE_MODULES'] = 'YES'
        config.build_settings['DEFINES_MODULE'] = 'YES'
        config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
        config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'
        # Convert double-quoted includes to angle-bracketed automatically
        config.build_settings['CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER'] = 'NO'
      end

      # Fix: Suppress ld "search path not found" warnings caused by
      # Xcode 26.x Metal toolchain cryptex (read-only filesystem).
      ldflags = config.build_settings['OTHER_LDFLAGS'] || ['$(inherited)']
      ldflags = [ldflags] if ldflags.is_a?(String)
      unless ldflags.include?('-Xlinker') && ldflags.include?('-w')
        ldflags.push('-Xlinker', '-w')
      end
      config.build_settings['OTHER_LDFLAGS'] = ldflags
    end
  end

  # Fix secp256k1.swift missing private module map warning
  installer.pods_project.targets.each do |target|
    if target.name == 'secp256k1.swift'
      target.build_configurations.each do |config|
        config.build_settings['MODULEMAP_PRIVATE_FILE'] = ''
        # Xcode 26 may warn: "there are private headers but no module map".
        # Ensure no private headers are emitted for this pod target.
        config.build_settings['PRIVATE_HEADERS_FOLDER_PATH'] = ''
      end
    end
  end

  # Patch EFQRCode headers to fix module verifier errors
  efqr_header = File.join(installer.sandbox.root, 'EFQRCode', 'Source', 'EFQRCode.h')
  if File.exist?(efqr_header)
    content = File.read(efqr_header)
    if content.include?('@import Foundation;')
      File.chmod(0644, efqr_header)
      File.write(efqr_header, content.gsub('@import Foundation;', '#import <Foundation/Foundation.h>'))
    end
  end
  efqr_umbrella = File.join(installer.sandbox.root, 'Target Support Files', 'EFQRCode', 'EFQRCode-umbrella.h')
  if File.exist?(efqr_umbrella)
    content = File.read(efqr_umbrella)
    if content.include?('#import "EFQRCode.h"')
      File.write(efqr_umbrella, content.gsub('#import "EFQRCode.h"', '#import <EFQRCode/EFQRCode.h>'))
    end
  end

  # Patch secp256k1.swift headers to fix module verifier errors
  secp256k1_umbrella = File.join(installer.sandbox.root, 'Target Support Files', 'secp256k1.swift', 'secp256k1.swift-umbrella.h')
  if File.exist?(secp256k1_umbrella)
    content = File.read(secp256k1_umbrella)
    patched = content
      .gsub('#import "secp256k1.h"', '#import <secp256k1/secp256k1.h>')
      .gsub('#import "secp256k1_ecdh.h"', '#import <secp256k1/secp256k1_ecdh.h>')
      .gsub('#import "secp256k1_recovery.h"', '#import <secp256k1/secp256k1_recovery.h>')
    File.write(secp256k1_umbrella, patched) if patched != content
  end
  secp256k1_include = File.join(installer.sandbox.root, 'secp256k1.swift', 'secp256k1', 'Classes', 'secp256k1', 'include')
  ['secp256k1_ecdh.h', 'secp256k1_recovery.h'].each do |header|
    path = File.join(secp256k1_include, header)
    if File.exist?(path)
      content = File.read(path)
      if content.include?('#include "secp256k1.h"')
        File.chmod(0644, path)
        File.write(path, content.gsub('#include "secp256k1.h"', '#include <secp256k1/secp256k1.h>'))
      end
    end
  end

  # Directly patch Pods-RabbyMobile xcconfig files:
  # 1. Add -Xlinker -w to suppress linker warnings
  # 2. Remove ${TOOLCHAIN_DIR} from LIBRARY_SEARCH_PATHS to avoid
  #    Metal cryptex search path resolution on Xcode 26.x
  Dir.glob(File.join(installer.sandbox.root, 'Target Support Files', 'Pods-RabbyMobile', '*.xcconfig')) do |xcconfig_path|
    content = File.read(xcconfig_path)
    unless content.include?('-Xlinker -w')
      content = content.gsub(
        /^(OTHER_LDFLAGS\s*=\s*.*)$/,
        '\1 -Xlinker -w'
      )
    end
    # Remove TOOLCHAIN_DIR library search path (resolves to Metal cryptex)
    content = content.gsub(
      /\s*"\$\{TOOLCHAIN_DIR\}\/usr\/lib\/swift\/\$\{PLATFORM_NAME\}"/,
      ''
    )
    File.write(xcconfig_path, content)
  end
end
